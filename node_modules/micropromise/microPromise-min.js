var task=require("microTask");(function(root){"use strict";try{root=global}catch(e){try{root=window}catch(e){}}var slice=Array.prototype.slice,isArray=Array.isArray;var uP=function microPromise(proto){if(proto&&typeof proto==="object"){for(var key in uP.prototype)proto[key]=uP.prototype[key];proto._tuple=[];return proto}if(!(this instanceof microPromise))return new microPromise(proto);this._tuple=[];if(typeof proto==="function"){proto(this.resolve,this.reject,this.progress,this.timeout)}};uP.prototype.then=function(f,r,n){var p=new uP;this._tuple[this._tuple.length]=[p,f,r,n];if(this._state)task(resolver,[this._tuple,this._state,this._value]);return p};uP.prototype.spread=function(f,r,n){function s(v){if(!isArray(v))v=[v];return f.apply(f,v)}return this.then(s,r,n)};uP.prototype.done=function(f,r,n){if(typeof r!=="function")r=handleError;var self=this,p=this.then(f,r,n);function handleError(e){task(function(){if(typeof self.onerror==="function"){self.onerror(e)}else{throw e}})}};uP.prototype.fulfill=function(x){if(!this._state){task(resolver,[this._tuple,this._state=1,this._value=x])}return this};uP.prototype.resolve=function(x){var then,z=0,p=this,z=0;if(!this._state){if(x===p)p.reject(new TypeError("x === p"));if(x&&(typeof x==="object"||typeof x==="function")){try{then=x.then}catch(e){p.reject(e)}}if(typeof then!=="function"){task(resolver,[this._tuple,this._state=1,this._value=x])}else if(!z){try{then.apply(x,[function(y){if(!z++)p.resolve(y)},function(r){if(!z++)p.reject(r)}])}catch(e){if(!z++)p.reject(e)}}}return this};uP.prototype.reject=function(x){if(!this._state){task(resolver,[this._tuple,this._state=2,this._value=x])}return this};uP.prototype.progress=function(){var args=slice.call(arguments),fn;for(var i=0,l=this._tuple.length;i<l;i++){if(typeof(fn=this._tuple[i][3])==="function")fn.apply(this,arguments)}};uP.prototype.timeout=function(msec,func){var p=this;if(msec===null){clearTimeout(p._timer);p._timer=null}else if(!p._timer){p._timer=setTimeout(onTimeout,msec)}function onTimeout(){var e=RangeError("exceeded timeout");if(!p._state){if(typeof func==="function")func(p);else if(typeof p.onerror==="function")p.onerror(e);else throw e}}return this};uP.prototype.wrap=function(proto){var p=this;return function(){var args=slice.call(arguments),ret;if(proto instanceof uP){proto.fulfill(args).then(p.fulfill,p.reject)}else if(typeof proto==="function"){try{ret=proto.apply(p,args);p.resolve(ret)}catch(err){p.reject(err)}}return p}};uP.prototype.defer=function(){var args=slice.call(arguments),proc=args.shift(),p=this;if(typeof proc==="function"){task(enclose,args)}function enclose(){try{p.resolve(proc.apply(p,args))}catch(err){p.reject(err)}}return this};uP.prototype.async=function(){var p=this,args=slice.call(arguments);function callback(err,ret){if(!err)p.fulfill(ret);else p.reject(ret)}args[args.length]=callback;return this.defer.apply(this,args)};uP.prototype.join=function(j){var p=this,y=[],u=(new uP).resolve(p).then(function(v){y[0]=v});if(arguments.length>1){j=slice.call(arguments)}if(!isArray(j))j=[j];function collect(i){j[i].done(function(v){y[i+1]=v},u.reject);return function(){return j[i]}}for(var i=0;i<j.length;i++){u=u.then(collect(i))}return u.then(function(){return y})};function resolver(tuple,state,value){var t,p,h,x=value;while(t=tuple.shift()){p=t[0];h=t[state];if(typeof h==="function"){try{x=h(value);p.resolve(x)}catch(e){p.reject(e)}}else{p._state=state;p._value=x;task(resolver,[p._tuple,p._state,p._value])}}}if(module&&module.exports)module.exports=uP;else if(typeof define==="function"&&define.amd)define(uP);else root.uP=uP})(this);